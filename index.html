<script type="module">
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    const vid = document.getElementById('v'), can = document.getElementById('c'), ctx = can.getContext('2d');
    let data = { logos: [], emojis: [], b: false };

    // UPDATED MODEL SELECTION
    // Using gemini-3-flash-preview for 2026 frontier performance
    const MODEL_NAME = "gemini-3-flash-preview"; 

    window.runGeminiAI = async function() {
        const key = document.getElementById('apiKey').value;
        if (!key) return alert("Please paste your API key first.");

        // Configured for v1beta to support the newest Gemini 3 preview features
        const genAI = new GoogleGenerativeAI(key);
        const model = genAI.getGenerativeModel({ 
            model: MODEL_NAME 
        });

        document.getElementById('status').innerText = "ü§ñ AI is analyzing... (Model: " + MODEL_NAME + ")";

        const frameData = can.toDataURL('image/jpeg').split(',')[1];
        const userPrompt = document.getElementById('aiPrompt').value;

        try {
            const result = await model.generateContent([
                `Task: Analyze this video frame for a 2025 recap. 
                 Request: "${userPrompt}" 
                 Output JSON: {"headline": "...", "filter": "vivid|noir|sepia", "effect": "paper|doodle|funky"}`,
                { inlineData: { data: frameData, mimeType: "image/jpeg" } }
            ]);
            
            const aiResponse = JSON.parse(result.response.text());
            document.getElementById('status').innerText = "‚ú® Design Applied: " + aiResponse.headline;
            bake(aiResponse);
        } catch (err) {
            // Error handling for 404s
            document.getElementById('status').innerText = "‚ùå Model Error. Try 'gemini-2.5-flash' instead.";
            console.error(err);
        }
    };
</script>
